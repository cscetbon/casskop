"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[6623],{3533:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"configuration_deployment/cassandra_configuration","title":"Cassandra Configuration","description":"Cassandra bootstrap","source":"@site/docs/3_configuration_deployment/5_cassandra_configuration.md","sourceDirName":"3_configuration_deployment","slug":"/configuration_deployment/cassandra_configuration","permalink":"/casskop/docs/configuration_deployment/cassandra_configuration","draft":false,"unlisted":false,"editUrl":"https://github.com/cscetbon/casskop/edit/master/website/docs/3_configuration_deployment/5_cassandra_configuration.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"title":"Cassandra Configuration","sidebar_label":"Cassandra Configuration"},"sidebar":"docs","previous":{"title":"Cluster topology","permalink":"/casskop/docs/configuration_deployment/cluster_topology"},"next":{"title":"Sidecars","permalink":"/casskop/docs/configuration_deployment/sidecars"}}');var i=a(4848),o=a(8453);const t={title:"Cassandra Configuration",sidebar_label:"Cassandra Configuration"},r=void 0,c={},d=[{value:"Cassandra bootstrap",id:"cassandra-bootstrap",level:2},{value:"Initcontainer 1 : base-config-builder",id:"initcontainer-1--base-config-builder",level:3},{value:"Initcontainer 2 : config-builder",id:"initcontainer-2--config-builder",level:3},{value:"Initcontainer 3 : bootstrap",id:"initcontainer-3--bootstrap",level:3},{value:"Nodes per rack",id:"nodes-per-rack",level:2},{value:"Configuration embedded in CassandraCluster",id:"configuration-embedded-in-cassandracluster",level:2},{value:"Configuration override using configMap",id:"configuration-override-using-configmap",level:2},{value:"Configuration pre_run.sh script",id:"configuration-pre_runsh-script",level:3},{value:"JVM options",id:"jvm-options",level:2},{value:"Memory",id:"memory",level:3},{value:"Authentication and authorizations",id:"authentication-and-authorizations",level:2}];function l(e){const n={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h2,{id:"cassandra-bootstrap",children:"Cassandra bootstrap"}),"\n",(0,i.jsx)(n.p,{children:"The configuration of the Cassandra image has been delegated to two init-containers that are executed prior to the Cassandra\ncontainer when the pod is started."}),"\n",(0,i.jsx)(n.p,{children:"There is a specific bootstrap image that is build from the docker directory and contains all required files or scripts\nto work with CassKop."}),"\n",(0,i.jsx)(n.h3,{id:"initcontainer-1--base-config-builder",children:"Initcontainer 1 : base-config-builder"}),"\n",(0,i.jsx)(n.p,{children:"The init container is responsible for the following actions :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"copy the default Cassandra configuration from user's provided Cassandra image."}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Configuration:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"The init-config container is by default the baseImage Cassandra image"}),"\n",(0,i.jsx)(n.li,{children:"The default command executed by the init-container is:"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"cp -vr /etc/cassandra/* /bootstrap\n"})}),"\n",(0,i.jsx)(n.h3,{id:"initcontainer-2--config-builder",children:"Initcontainer 2 : config-builder"}),"\n",(0,i.jsx)(n.p,{children:"This container is responsible for the following actions :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Generate all the cassandra configuration (cassandra.yaml, java. etc..) from the different config entries in the\nCassandraCluster object level (spec, datacenters and racks)"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["It uses ",(0,i.jsx)(n.a,{href:"https://github.com/datastax/cass-config-builder",children:"cass-config-builder"})," which is a tool developed by Datastax."]}),"\n",(0,i.jsx)(n.h3,{id:"initcontainer-3--bootstrap",children:"Initcontainer 3 : bootstrap"}),"\n",(0,i.jsx)(n.p,{children:"The bootstrap Container :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Adding files and additional jar from the bootstrap image to the default configuration"}),"\n",(0,i.jsx)(n.li,{children:"Applying a configmap on top of the default configuration"}),"\n",(0,i.jsxs)(n.li,{children:["Modifying the configuration to be suitable to run with CassKop:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Updating the cluster name"}),"\n",(0,i.jsx)(n.li,{children:"Setting the seedlist"}),"\n",(0,i.jsx)(n.li,{children:"Adding a Cassandra exporter and Jolokia agent"}),"\n",(0,i.jsx)(n.li,{children:".."}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["We provide the bootstrap image, but you can change it using ",(0,i.jsx)(n.code,{children:"Spec.bootstrapImage"})," but you need to comply with the\nrequired actions, see ",(0,i.jsx)(n.a,{href:"https://github.com/cscetbon/casskop/tree/master/docker/bootstrap",children:"Bootstrap"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"nodes-per-rack",children:"Nodes per rack"}),"\n",(0,i.jsxs)(n.p,{children:["One of the requirements for CassKop is to always keep the same number of nodes in each of its racks per Cassandra DCs. The number of nodes used for the Cassandra Cluster is configured using the ",(0,i.jsx)(n.code,{children:"CassandraCluster.spec.nodesPerRacks"}),"\nproperty."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["If you have not specify a Cluster Topology, then you'll have a default datacenter named ",(0,i.jsx)(n.code,{children:"dc1"})," and a default rack named\n",(0,i.jsx)(n.code,{children:"rack1"})]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"CassKop will keep the same number of nodes in each Cassandra rack as it is a good practice for Cassandra."}),"\n",(0,i.jsxs)(n.p,{children:["You can define different numbers of replicas for racks in different Cassandra DataCenters using the ",(0,i.jsx)(n.code,{children:"nodesPerRacks"})," property at the datacenter level. (in ",(0,i.jsx)(n.code,{children:"CassandraCluster.spec.topology.dc[<idx>].nodesPerRacks"}),"). If\nspecified on the datacenter level, this parameter takes priority over the global ",(0,i.jsx)(n.code,{children:"CassandraCluster.spec.nodesPerRacks"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Example:\nexample to scale up the nodesPerRacks in DC2 :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"  topology:\n    dc:\n      - name: dc1\n        rack:\n          - name: rack1\n          - name: rack2\n      - name: dc2\n        nodesPerRacks: 3        <--- We increase by one this value\n        rack:\n          - name: rack1\n"})}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"The number of Cassandra nodes will be the multiplication of the number of racks * the nodesPerRacks value."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["If we changes on of these properties then CassKop will trigger either a ",(0,i.jsx)(n.a,{href:"/casskop/docs/operations/cluster_operations#scaleup",children:"ScaleUp"}),"\nor a ",(0,i.jsx)(n.a,{href:"/casskop/docs/operations/cluster_operations#scaledown",children:"ScaleDown"})," operation."]}),"\n",(0,i.jsx)(n.h2,{id:"configuration-embedded-in-cassandracluster",children:"Configuration embedded in CassandraCluster"}),"\n",(0,i.jsx)(n.p,{children:"The configuration of the different components of Cassandra can be changed in the object and be overriden at different\nlevels. Here is an example showing how to update some Java and Cassdnra parameters as well and overwrite them at the\ndatacenter and rack level:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: db.orange.com/v2\nkind: CassandraCluster\nmetadata:\n  name: cassandra-demo\nspec:\n  nodesPerRacks: 1\n  cassandraImage: cassandra:3.11.7\n  restartCountBeforePodDeletion: 3\n  dataStorageClass: local-storage\n  hardAntiAffinity: false\n  deletePVC: true\n  autoPilot: true\n  resources:\n    limits:\n      cpu: 1\n      memory: 2Gi\n  config:\n    cassandra-yaml:\n      num_tokens: 64\n  topology:\n    dc:\n      - name: dc1\n        config:\n          cassandra-yaml:\n            num_tokens: 32\n        resources:\n          limits:\n            cpu: 3\n            memory: 3Gi\n        labels:\n          location.dfy.orange.com/site : mts\n        rack:\n          - name: rack1\n            labels:\n              location.dfy.orange.com/street : street1\n          - name: rack2\n            labels:\n              location.dfy.orange.com/street : street2\n            config:\n              cassandra-yaml:\n                num_tokens: 16\n      - name: dc2\n        nodesPerRacks: 1\n        labels:\n          location.dfy.orange.com/site : mts\n        rack:\n          - name: rack1\n            labels:\n              location.dfy.orange.com/street : street3\n"})}),"\n",(0,i.jsx)(n.h2,{id:"configuration-override-using-configmap",children:"Configuration override using configMap"}),"\n",(0,i.jsxs)(n.p,{children:["CassKop allows you to customize the configuration of Apache Cassandra nodes by specifying a dedicated ",(0,i.jsx)(n.code,{children:"ConfigMap"}),"\nname in the ",(0,i.jsx)(n.code,{children:"CassandraCluster.spec.configMapName"})," containing configuration files to be overwritten above the default\nconfiguration files of the dedicated Docker Image."]}),"\n",(0,i.jsxs)(n.p,{children:["We have a specific Cassandra Docker image startup script that will overwrite each file in the directory\n",(0,i.jsx)(n.code,{children:"/etc/cassandra"}),", from the one specified in the configMap if they exist."]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:["You can surcharge any files in the docker image ",(0,i.jsx)(n.code,{children:"/etc/cassandra"})," with the ConfigMap."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Typical overwriting files may be :"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"specifying a pre_run.sh and/or post_run.sh script"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"See the example below:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: cassandra-configmap-v1\ndata:\n\n  pre_run.sh: |-\n    echo "  ** this is pre_run.sh script executed before run.sh **"\n    #Examples:\n    echo "Change default Authenticator & Authorizer"\n    sed -ri \'s/(authenticator:).*/\\1 PasswordAuthenticator/\' /etc/cassandra/cassandra.yaml\n    sed -ri \'s/(authorizer:).*/\\1 CassandraAuthorizer/\' /etc/cassandra/cassandra.yaml\n    #test "$(hostname)" == \'cassandra-demo-dc1-rack2-0\' && echo "update param" && sed -i \'s/windows_timer_interval: 1/windows_timer_interval: 2/\' /etc/cassandra/cassandra.yaml\n    #test "$(hostname)" == \'cassandra-demo-dc1-rack3-0\' && echo "-Dcassandra.replace_address_first_boot=172.31.183.209" > /etc/cassandra/jvm.options\n    #test "$(hostname)" == \'cassandra-demo-dc2-rack1-0\' && echo "-Dcassandra.override_decommission=true" > /etc/cassandra/jvm.options\n    echo "  ** end of pre_run.sh script, continue with run.sh **"\n  post_run.sh: |-\n    echo "Check Configured seeds by bootstrap"\n    grep "seeds:" /etc/cassandra/cassandra.yaml\n'})}),"\n",(0,i.jsx)(n.p,{children:"You can create the ConfigMap above from the repo:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl apply -f config/cassandra-configmap-v1.yaml\nconfigmap "cassandra-configmap-v1" created\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Now you can add the ",(0,i.jsx)(n.code,{children:"configMapName: cassandra-configmap-v1"})," to the Spec section of your CassandraCluster definition\n",(0,i.jsx)(n.a,{href:"https://github.com/cscetbon/casskop/tree/master/config/samples/cassandracluster.yaml",children:"example"})]}),"\n",(0,i.jsx)(n.p,{children:"If you edit the ConfigMap it won't be detected neither by CassKop nor by the statefulsets/pods (unless you reboot the\npods).\nIt is recommended for configuration changes, to version the configmap and to create apply new configmap in the CRD, this\nwill trigger a rollingRestart of the whole cluster applying the new configuration."}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.p,{children:["each time you specify a new configMap CassKop will start a ",(0,i.jsx)(n.code,{children:"rollingUpdate"})," of all nodes\nin the cluster. more info on ",(0,i.jsx)(n.a,{href:"/casskop/docs/operations/cluster_operations#updateconfigmap",children:"UpdateConfigMap"})]})}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.p,{children:["At this time CassKop won't allow you to specify only excerpt of the configurations files, your\nConfigMap ",(0,i.jsx)(n.strong,{children:"MUST"})," contain valid and complete configuration files"]})}),"\n",(0,i.jsx)(n.h3,{id:"configuration-pre_runsh-script",children:"Configuration pre_run.sh script"}),"\n",(0,i.jsxs)(n.p,{children:["In case you need to make some specific actions on a particular node, such as make use of the ",(0,i.jsx)(n.strong,{children:"CASSANDRA_REPLACE_NODE"}),"\nvariable, you can use the pre_run.sh script in the ConfigMap. If present, the cassandra docker will execute this script\nprior to the ",(0,i.jsx)(n.code,{children:"run.sh"})," script from the docker image."]}),"\n",(0,i.jsx)(n.p,{children:"Example of a configMap with the pre_run.sh script :"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: cassandra-configmap-pre-run\ndata:\n  pre_run.sh: |-\n    echo "** this is a pre-scrip for run.sh that can be edit with configmap"\n    test "$(hostname)" == \'cassandra-demo-dc1-rack1-0\' && export CASSANDRA_REPLACE_NODE=10.233.93.174\n    echo "** end of pre_run.sh script, continue with run.sh"\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsx)(n.p,{children:"In the case you use the configmap for one-time specific action, don't forget to edit again to remove\nthe specific treatment once it is no more needed."})}),"\n",(0,i.jsx)(n.h2,{id:"jvm-options",children:"JVM options"}),"\n",(0,i.jsx)(n.h3,{id:"memory",children:"Memory"}),"\n",(0,i.jsx)(n.p,{children:"Apache Cassandra is running inside a Java Virtual Machine (JVM). JVM has many configuration options to optimize the\nperformance for different platforms and architectures."}),"\n",(0,i.jsxs)(n.p,{children:["CassKop allows configuring these values by adding a ",(0,i.jsx)(n.code,{children:"jvm.options"})," in the user ",(0,i.jsx)(n.code,{children:"ConfigMap"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The default value used for ",(0,i.jsx)(n.code,{children:"-Xmx"})," depends on whether there is a memory request configured for the container :"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"If there is a memory request, the JVM's maximum memory must be set to a value corresponding to the limit."}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:'When there is no memory request, CassKop will limit it to "2048M".'}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"set the memory request and the memory limit to the same value, so that the pod is in guarantee mode"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsx)(n.p,{children:"CassKop will automatically compute the initial and max heap size from 1/4 of the available defined resources."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"authentication-and-authorizations",children:"Authentication and authorizations"}),"\n",(0,i.jsx)(n.p,{children:"CassKop uses Jolokia from the cassandra-image to communicate. We can add\nauthentication on Jolokia by defining a secret :"}),"\n",(0,i.jsx)(n.p,{children:"Example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: jolokia-auth\ntype: Opaque\ndata:\n  password: TTBucDQ1NXcwcmQ=\n  username: am9sb2tpYS11c2Vy\n"})}),"\n",(0,i.jsxs)(n.p,{children:["and in the CRD you will define ",(0,i.jsx)(n.code,{children:"spec.imageJolokiaSecret"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-console",children:"...\n  imageJolokiaSecret:\n    name: jolokia-auth\n...\n"})}),"\n",(0,i.jsx)(n.p,{children:"CassKop will propagate the secrets in Cassandra so that it can configure Jolokia and use it to connect."})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453:(e,n,a)=>{a.d(n,{R:()=>t,x:()=>r});var s=a(6540);const i={},o=s.createContext(i);function t(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);